{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid mt-4 mb-4 px-4">

  <!-- =========================
       PAGE TITLE
  ========================== -->
  <div class="mb-4">
    <h2 class="fw-semibold mobile-fonts">Edit Assessment</h2>
  </div>

  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">
        Patient: <strong>{{ assessment.patient_name }}</strong>
      </h5>

      <h6 class="mb-0 text-muted">
        File No: <strong>{{ assessment.file_number }}</strong>
      </h6>
    </div>
  </div>
  <form id="section2Form">

    <!-- =========================
         SECTION 2 – PRESENTING COMPLAINT
    ========================== -->
    <h4 class="fw-semibold mb-3 mobile-fonts">Section 2 – Presenting Complaint</h4>

    <!-- =========================
         ASSIGNMENT
    ========================== -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header fw-semibold">
        Assignment
      </div>
      <div class="card-body">
        {% if is_readonly %}
        <div class="alert alert-warning">
          You are viewing this assessment in read-only mode because you are not the assigned evaluator.
        </div>
        {% endif %}

        {% if assessment.is_section_2_signed %}
        <div class="alert alert-success">
          <strong>Signed-off by:</strong>
          {{ assessment.section_2_signed_by.official_name }}
          ({{ assessment.section_2_signed_by.role|title }})<br>
          <small class="text-muted">
            Signed at: {{ assessment.section_2_signed_at|date:"d M Y, h:i A" }}
          </small>
        </div>
        {% endif %}

        <div class="row">
          <!-- Student dropdown -->
          <div class="col-md-6 mb-3">
            <label class="form-label required">Student</label>
            <select name="student" class="form-control" required
              {% if student_readonly or is_readonly %}disabled{% endif %}>
              <option value="">-- Select Student --</option>
              {% for s in students %}
              <option value="{{ s.id }}" {% if assessment and assessment.student.id == s.id %}selected{% endif %}
                {% if not assessment and student_readonly and request.user.profile.id == s.id %}selected{% endif %}>
                {{ s.member_id }} – {{ s.official_name }}
              </option>
              {% endfor %}
            </select>
            {% if student_readonly %}
            <!-- preserve value for API since disabled fields are not submitted -->
            <input type="hidden" name="student" value="{{ request.user.profile.id }}">
            {% endif %}
          </div>

          <!-- Evaluator dropdown -->
          <div class="col-md-6 mb-3">
            <label class="form-label required">Evaluator (Clinician)</label>
            <select name="evaluator" class="form-control" required {% if is_readonly %}disabled{% endif %}>
              <option value="">-- Select Clinician --</option>
              {% for c in clinicians %}
              <option value="{{ c.id }}" {% if assessment and assessment.evaluator.id == c.id %}selected{% endif %}>
                {{ c.member_id }} – {{ c.official_name }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- =========================
        PRESENTING COMPLAINT
    ========================== -->
    <div class="card mt-4 shadow-sm">
      <div class="card-header fw-semibold">Presenting Complaint</div>
      <div class="card-body">

        <div class="mb-3">
          <label class="form-label required">Chief Complaint</label>
          <textarea name="chief_complaint" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.chief_complaint|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">History of Condition</label>
          <textarea name="history_of_condition" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.history_of_condition|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Pain</label>
          <textarea name="pain" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.pain|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Aggravating Factors</label>
          <textarea name="aggravating_factors" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.aggravating_factors|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Relieving Factors</label>
          <textarea name="relieving_factors" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.relieving_factors|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Associated Symptoms</label>
          <textarea name="associated_symptoms" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.associated_symptoms|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Health History Review</label>
          <textarea name="health_hx_review" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.health_hx_review|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Past Illnesses</label>
          <textarea name="past_illnesses" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.past_illnesses|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Family History</label>
          <textarea name="family_hx" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.family_hx|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Psycho Social History</label>
          <textarea name="psycho_social_hx" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.psycho_social_hx|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Occupational</label>
          <textarea name="occupational" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.occupational|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Diet</label>
          <textarea name="diet" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.diet|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">System Review</label>
          <textarea name="system_review" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.system_review|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label required">Differential Diagnosis</label>
          <textarea name="differential_diagnosis" class="form-control" rows="3" required
            {% if is_readonly %}readonly{% endif %}>{{ assessment.differential_diagnosis|default_if_none:'' }}</textarea>
        </div>
      </div>
    </div>


    <!-- =========================
            SUBMIT
        ========================== -->
    <div class="mt-4 d-flex justify-content-end gap-2">
      <a href="{% url 'assessments_list' %}" class="btn btn-secondary btn-mobile">Cancel</a>
      <!-- Hide button if user is only able to readonly -->
      {% if not is_readonly %}
      <button type="submit" id="btnSave" name="action" value="save_section_2" class="btn btn-primary btn-mobile">
        Update Assessment
      </button>

      {% if assessment and request.user.profile.role in "clinician admin" and not assessment.is_section_2_signed %}
      <button type="submit" id="btnSignOff" name="action" value="sign_off_section_2" class="btn btn-success btn-mobile">
        Update & Sign Off Section 2
      </button>
      {% endif %}
      {% endif %}
    </div>

  </form>
</div>

<script>
  document.getElementById("btnSave").addEventListener("click", function () {
    clickedAction = "save_section_2";
  }); {
    %
    if assessment and request.user.profile.role in "clinician admin"
    and not assessment.is_section_2_signed %
  }
  document.getElementById("btnSignOff").addEventListener("click", function () {
    clickedAction = "sign_off_section_2";
  }); {
    %
    endif %
  }

  // ===========================
  // Save confirmation and submission
  // ===========================
  document.getElementById("section2Form").addEventListener("submit", function (e) {
    e.preventDefault();

    let confirmMessage = "Are you sure you want to save the changes? All next sections sign-offs will be reset.";

    if (clickedAction === "sign_off_section_2") {
      confirmMessage =
        "Are you sure you want to UPDATE and SIGN OFF Section 2?";
    }

    if (!confirm(confirmMessage)) {
      return;
    }

    // ==========================
    // Proceed with save
    // ==========================
    const formData = new FormData(this);
    formData.set("action", clickedAction);

    const payload = {};
    formData.forEach((v, k) => payload[k] = v);

    payload["assessment_id"] = "{{ assessment.id }}";
    const method = "PUT";

    fetch("{% url 'assessment_section1_and_2_api' %}", {
        method: method,
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": CSRFTOKEN
        },
        body: JSON.stringify(payload)
      })
      .then(res => {
        if (!res.ok) return res.json().then(err => {
          throw err;
        });
        return res.json();
      })
      .then(data => {
        alert(data.message || "Success");
        window.location.href = "{% url 'assessments_list' %}";
      })
      .catch(err => {
        console.error(err);
        alert("Failed. Please check required fields.");
      });
  });
</script>


{% endblock %}