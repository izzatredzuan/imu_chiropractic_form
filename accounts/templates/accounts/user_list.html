{% extends 'base.html' %}

{% block style %}
<!-- Add any extra styling if needed -->
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Users</h1>

    <button id="createUserBtn" class="btn btn-primary mb-3">Create User</button>

    <table id="userTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Official Name</th>
                <th>Username</th>
                <th>Member ID</th>
                <th>Role</th>
                <th>Phone</th>
                <th>Admin</th>
                <th>Action</th>
            </tr>
        </thead>
    </table>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editMemberId">
                    <div class="mb-3">
                        <label>Official Name</label>
                        <input type="text" id="editOfficialName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Role</label>
                        <select id="editRoleSelect" class="form-control">
                            <option value="student">Student</option>
                            <option value="clinician">Clinician</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Phone</label>
                        <input type="text" id="editPhone" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Admin?</label>
                        <input type="checkbox" id="editIsAdmin">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveEditBtn" class="btn btn-primary">Save</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Mapping to capitalize role in table display
        const roleMap = {
            "student": "Student",
            "clinician": "Clinician",
            "admin": "Admin"
        };

        const table = $('#userTable').DataTable({
            ajax: {
                url: "{% url 'user_api' %}",
                dataSrc: ''
            },
            columns: [{
                    data: 'official_name'
                },
                {
                    data: 'username'
                },
                {
                    data: 'member_id'
                },
                {
                    data: 'role',
                    render: function (data) {
                        return roleMap[data] || data;
                    }
                },
                {
                    data: 'phone'
                },
                {
                    data: 'is_admin',
                    render: data => data ? 'Yes' : 'No'
                },
                {
                    data: null,
                    render: function (data) {
                        return `
                        <button class="editBtn btn btn-sm btn-primary" 
                            data-id="${data.member_id}" 
                            data-role="${data.role}" 
                            data-official-name="${data.official_name}" 
                            data-phone="${data.phone}" 
                            data-is-admin="${data.is_admin}">Edit</button>
                        <button class="deleteBtn btn btn-sm btn-danger" data-id="${data.member_id}">Delete</button>
                    `;
                    }
                }
            ]
        });

        $('#createUserBtn').click(function () {
            window.location.href = "/";
        });

        // Edit button
        $('#userTable').on('click', '.editBtn', function () {
            const memberId = $(this).data('id');
            $('#editMemberId').val(memberId);
            $('#editOfficialName').val($(this).data('official-name'));
            $('#editRoleSelect').val($(this).data('role')); // send lowercase value
            $('#editPhone').val($(this).data('phone'));
            $('#editIsAdmin').prop('checked', $(this).data('is-admin'));
            $('#editUserModal').modal('show');
        });

        $('#saveEditBtn').click(function () {
            const memberId = $('#editMemberId').val();
            $.ajax({
                url: "{% url 'user_update_api' %}",
                type: 'PUT',
                headers: {
                    'X-CSRFToken': CSRFTOKEN
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    member_id: memberId,
                    official_name: $('#editOfficialName').val(),
                    role: $('#editRoleSelect').val(), // send lowercase
                    phone: $('#editPhone').val(),
                    is_admin: $('#editIsAdmin').is(':checked')
                }),
                success: function () {
                    table.ajax.reload(null, false);
                    $('#editUserModal').modal('hide');
                },
                error: function () {
                    alert('Update failed');
                }
            });
        });

        // Delete button
        $('#userTable').on('click', '.deleteBtn', function () {
            const memberId = $(this).data('id');
            if (!confirm('Delete this user?')) return;

            $.ajax({
                url: "{% url 'user_delete_api' %}",
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': CSRFTOKEN
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    member_id: [memberId]
                }),
                success: function () {
                    table.ajax.reload(null, false);
                },
                error: function () {
                    alert('Delete failed');
                }
            });
        });
    });
</script>
{% endblock %}